#!/bin/bash

tmpdir=/tmp/slides-$(date +%s%N |md5sum |cut -c 1-6) 

#Cleanup temp dir on exit (Ctrl+C or Ctrl+\)
trap "echo 'Cleaning up...'; rm -r $tmpdir; exit" SIGINT SIGQUIT

if [ $# -eq 0  ]
then
  echo "No markdown file specified."
  echo "Usage: md2reveal.sh <md-file>"
  exit
fi

echo "mdslides started"

script_dir=${0%/*};
#Copy reveal.js framework to temp dir
pushd $script_dir;
rsync -r --exclude=.git . $tmpdir;
popd;

firsttime=true;

while true 
do 
  cp $1 $tmpdir/tmp.md;
  cp pic/* $tmpdir/pic;

  pushd $tmpdir;

  #Remove comments (lines start with '//')
  grep -v "^//.*$" tmp.md >> tmp1.md;
  mv tmp1.md tmp.md;

  #Put the content into the template
  sed -e "/Your content will be here./r tmp.md" -e "//d" $tmpdir/template.html> $tmpdir/$1.html ;
  echo "$1.html refreshed.";

  popd;

  if $firsttime
  then
    firefox $tmpdir/$1.html;
    firsttime=false;
  fi 

  inotifywait -e close_write $1 ;
done

